<style>
    /* Yeni Wallet & Admin CSS */
    .status-badge { font-size: 0.5rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; margin-left: 5px; }
    .status-pending { background: var(--s); color: black; }
    
    .loading-spinner {
        width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white; border-radius: 50%; animation: load-spin 0.6s linear infinite;
        display: inline-block; margin-right: 8px;
    }
    @keyframes load-spin { to { transform: rotate(360deg); } }

    .confirm-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 2000; display: none;
        align-items: center; justify-content: center; padding: 30px;
    }
    
    .withdraw-card { 
        background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(0,0,0,0.5));
        border: 1px solid var(--p); position: relative; overflow: hidden;
    }
</style>

<div id="v-wallet" class="view">
    <h2 style="font-family:'Orbitron'; margin-bottom:20px; font-size:1.4rem; color:var(--p);">DIGITAL WALLET</h2>
    
    <div class="glass withdraw-card">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
                <p style="font-size:0.6rem; opacity:0.6;">AVAILABLE TO WITHDRAW</p>
                <h2 id="w-disp-pi" style="color:white; font-size:1.8rem; font-family:'Orbitron';">0.00</h2>
            </div>
            <img src="pico.jpg" style="width:40px; border-radius:50%; box-shadow: 0 0 15px var(--p);">
        </div>
    </div>

    <div class="glass">
        <p style="font-size:0.7rem; margin-bottom:10px;">WITHDRAWAL REQUEST</p>
        <div class="input-group">
            <label style="font-size:0.5rem; opacity:0.5;">DESTINATION PI ADDRESS</label>
            <input type="text" id="w-addr" placeholder="GAb123...xyz">
        </div>
        <div class="input-group">
            <label style="font-size:0.5rem; opacity:0.5;">AMOUNT (MIN 30)</label>
            <input type="number" id="w-amt" placeholder="0.00">
        </div>
        
        <button class="btn btn-p" id="withdraw-btn" onclick="processWithdraw()">
            <span id="btn-text">CONFIRM WITHDRAWAL</span>
        </button>
        <p style="font-size:0.55rem; opacity:0.4; text-align:center; margin-top:10px;">
            Fees: 0.5 PI | Network: Pi Mainnet
        </p>
    </div>
</div>

<div id="v-admin" class="view">
    <h2 style="color:var(--red); font-family:'Orbitron'; margin-bottom:20px;">SYSTEM CONTROL</h2>
    
    <div class="glass" style="border-color: var(--s);">
        <p style="font-size:0.7rem; color:var(--s); font-weight:900; margin-bottom:10px;">ðŸ’° PENDING PAYMENTS</p>
        <div id="adm-pulls">
            </div>
    </div>

    <div class="glass">
        <p style="font-size:0.7rem; opacity:0.6; margin-bottom:10px;">ðŸ‘¥ USER MANAGEMENT</p>
        <div id="adm-users"></div>
    </div>
</div>

<script>
// --- WALLET FUNCTIONS ---
async function processWithdraw() {
    const btn = document.getElementById('withdraw-btn');
    const amt = parseFloat(document.getElementById('w-amt').value);
    const addr = document.getElementById('w-addr').value.trim();

    // Onaylamalar & UyarÄ±lar
    if (!addr || addr.length < 10) return tg.showAlert("Please enter a valid Pi address.");
    if (isNaN(amt) || amt < 30) return tg.showAlert("Minimum withdrawal is 30 PI.");
    if (uData.pi < amt) return tg.showAlert("Insufficient balance!");

    // Animasyon BaÅŸlat
    btn.disabled = true;
    btn.innerHTML = `<span class="loading-spinner"></span> PROCESSING...`;

    try {
        // Firebase Ä°ÅŸlemi
        await db.collection("withdrawals").add({
            uid: realUid,
            username: uData.username,
            addr: addr,
            amt: amt,
            status: "pending",
            timestamp: Date.now()
        });

        await db.collection("users").doc(realUid).update({
            pi: firebase.firestore.FieldValue.increment(-amt)
        });

        // BaÅŸarÄ± OnayÄ±
        btn.style.background = "var(--green)";
        btn.innerHTML = "âœ“ REQUEST SENT";
        tg.HapticFeedback.notificationOccurred('success');
        
        setTimeout(() => {
            btn.disabled = false;
            btn.style.background = "var(--p)";
            btn.innerHTML = "CONFIRM WITHDRAWAL";
            document.getElementById('w-amt').value = "";
        }, 3000);

    } catch (e) {
        tg.showAlert("System error: " + e.message);
        btn.disabled = false;
        btn.innerHTML = "CONFIRM WITHDRAWAL";
    }
}

// --- ADMIN PANEL FUNCTIONS ---
async function loadAdmin() {
    const wBox = document.getElementById('adm-pulls');
    const uBox = document.getElementById('adm-users');

    // 1. Ã–deme Taleplerini Getir
    const pSnap = await db.collection("withdrawals").where("status", "==", "pending").orderBy("timestamp", "desc").get();
    wBox.innerHTML = pSnap.empty ? "<p style='font-size:0.6rem; opacity:0.4;'>No pending requests.</p>" : "";
    
    pSnap.forEach(doc => {
        const p = doc.data();
        wBox.innerHTML += `
            <div class="u-card" style="border-left-color:var(--s); background:rgba(251,191,36,0.05);">
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-size:0.7rem; font-weight:900;">@${p.username}</span>
                    <span style="color:var(--s); font-weight:900;">${p.amt} PI</span>
                </div>
                <p style="font-size:0.5rem; opacity:0.6; word-break:break-all; margin:5px 0;">${p.addr}</p>
                <div style="display:flex; gap:5px; margin-top:8px;">
                    <button class="btn" style="padding:5px; background:var(--green); font-size:0.5rem;" onclick="handlePayment('${doc.id}', 'paid')">MARK PAID</button>
                    <button class="btn" style="padding:5px; background:var(--red); font-size:0.5rem;" onclick="handlePayment('${doc.id}', 'rejected', '${p.uid}', ${p.amt})">REJECT</button>
                </div>
            </div>`;
    });

    // 2. KullanÄ±cÄ± Listesini Getir (Ã–nceki fonksiyonun geliÅŸtirilmiÅŸ hali)
    const uSnap = await db.collection("users").limit(20).get();
    uBox.innerHTML = "";
    uSnap.forEach(doc => {
        const d = doc.data();
        uBox.innerHTML += `
            <div class="u-card">
                <div style="font-size:0.7rem;"><b>@${d.username}</b> <small style="opacity:0.5;">${doc.id}</small></div>
                <div style="font-size:0.6rem; margin-top:3px;">PI: ${d.pi.toFixed(2)} | PNX: ${d.pnx}</div>
                <button onclick="enter('${doc.id}')" style="margin-top:5px; font-size:0.5rem; width:100%; border:1px solid var(--p); background:none; color:var(--p); border-radius:5px; padding:3px;">LOGIN AS USER</button>
            </div>`;
    });
}

async function handlePayment(docId, status, uid = null, amt = 0) {
    if (!confirm("Are you sure?")) return;

    if (status === 'paid') {
        await db.collection("withdrawals").doc(docId).update({ status: "paid" });
    } else if (status === 'rejected') {
        // Reddedilirse parayÄ± iade et
        await db.collection("users").doc(uid).update({ pi: firebase.firestore.FieldValue.increment(amt) });
        await db.collection("withdrawals").doc(docId).delete();
    }
    loadAdmin();
    tg.HapticFeedback.impactOccurred('medium');
}

// Bakiye gÃ¶stergesini anlÄ±k gÃ¼ncellemek iÃ§in render'a ekle
function render() {
    document.getElementById('h-pi').innerText = (uData.pi || 0).toFixed(2);
    document.getElementById('w-disp-pi').innerText = (uData.pi || 0).toFixed(2); // Wallet iÃ§i bakiye
    document.getElementById('h-pnx').innerText = Math.floor(uData.pnx || 0);
    document.getElementById('ref-code-display').innerText = realUid;
}
</script>
