<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Koalas Pro Hub</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCfQGeQUVom6cX8aDyfXdGNly0L1Rlj87I",
            authDomain: "fonixapp.firebaseapp.com",
            projectId: "fonixapp",
            storageBucket: "fonixapp.firebasestorage.app",
            messagingSenderId: "980255542194",
            appId: "1:980255542194:web:883a3f7a8fc05fee6332ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        const user = tg.initDataUnsafe?.user;
        const myID = user?.id ? user.id.toString() : "8392479231";
        const myUsername = user?.username || user?.first_name || "KoalaUser";
        const myPhoto = user?.photo_url || `https://ui-avatars.com/api/?name=${myUsername}&background=random`;

        let userData = { kls: 0, usdt: 0 };

        async function init() {
            const userRef = doc(db, "users", myID);
            const snap = await getDoc(userRef);

            if (snap.exists()) {
                userData = snap.data();
            } else {
                userData = { 
                    kls: 0, 
                    usdt: 0, 
                    username: myUsername, 
                    photo: myPhoto,
                    invitedBy: tg.initDataUnsafe?.start_param || "" 
                };
                await setDoc(userRef, userData);
            }
            
            updateUI();
            loadFriends();
        }

        // UI G√ºncelleme
        function updateUI() {
            document.getElementById('user-display-name').innerText = myUsername;
            document.getElementById('main-kls').innerText = userData.kls.toFixed(2);
            document.getElementById('main-usdt').innerText = userData.usdt.toFixed(4);
            document.getElementById('ref-link-text').innerText = `https://t.me/SeninBotUserAdin?start=${myID}`;
        }

        // Firebase'den Arkada≈ü Listesini √áekme
        async function loadFriends() {
            const q = query(collection(db, "users"), where("invitedBy", "==", myID));
            const snap = await getDocs(q);
            const list = document.getElementById('friends-list');
            list.innerHTML = "";
            
            document.getElementById('friend-count').innerText = snap.size;

            if (snap.empty) {
                list.innerHTML = "<p style='opacity:0.5'>Hen√ºz kimseyi davet etmediniz.</p>";
                return;
            }

            snap.forEach(d => {
                const data = d.data();
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.innerHTML = `
                    <img src="${data.photo || 'https://via.placeholder.com/40'}" class="friend-img">
                    <div class="friend-info">
                        <div class="name">@${data.username}</div>
                        <div class="reward">Bonus: +$0.05</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Sekme Deƒüi≈ütirme
        window.showTab = (tabId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav'));
            event.currentTarget.classList.add('active-nav');
        };

        window.copyRef = () => {
            const link = document.getElementById('ref-link-text').innerText;
            navigator.clipboard.writeText(link);
            tg.showAlert("Davet linki kopyalandƒ±!");
        };

        window.onload = init;
    </script>

    <style>
        :root { --purple: #6c5ce7; --yellow: #fdcb6e; --bg: #0f0c29; --card: rgba(255, 255, 255, 0.08); }
        
        body { margin: 0; background: var(--bg); color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        
        #app { height: 100vh; display: flex; flex-direction: column; }
        
        /* Sayfa Yapƒ±sƒ± */
        .page { display: none; flex: 1; flex-direction: column; padding: 20px; overflow-y: auto; }
        .active { display: flex; }

        /* Kart Tasarƒ±mlarƒ± */
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        
        /* C√ºzdan */
        .wallet-header { text-align: center; padding: 20px 0; }
        .balance-title { font-size: 14px; opacity: 0.7; margin-bottom: 5px; }
        .balance-value { font-size: 36px; font-weight: bold; color: var(--yellow); }
        .withdraw-btn { background: var(--purple); color: #fff; border: none; width: 100%; padding: 15px; border-radius: 15px; font-size: 16px; font-weight: bold; margin-top: 10px; }

        /* Arkada≈ülar */
        .ref-box { background: #000; padding: 15px; border-radius: 12px; font-family: monospace; font-size: 12px; word-break: break-all; margin-top: 10px; cursor: pointer; }
        .friend-item { display: flex; align-items: center; gap: 15px; background: var(--card); padding: 12px; border-radius: 15px; margin-bottom: 10px; }
        .friend-img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--purple); }
        .friend-info .name { font-weight: bold; font-size: 15px; }
        .friend-info .reward { font-size: 12px; color: var(--yellow); }

        /* Alt Navigasyon */
        .nav-bar { height: 75px; background: rgba(0,0,0,0.8); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .nav-btn { background: none; border: none; color: #fff; opacity: 0.4; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.3s; }
        .nav-btn span { font-size: 20px; }
        .active-nav { opacity: 1; color: var(--yellow); transform: translateY(-3px); }

        h2 { margin: 0 0 15px 0; font-size: 22px; }
    </style>
</head>
<body>

<div id="app">
    <div id="p-home" class="page active">
        <div class="card" style="text-align:center;">
            <img src="koalasmining.jpg" style="width:120px; border-radius:50%; border:4px solid var(--purple);">
            <h2 style="margin-top:15px;">Merhaba, <span id="user-display-name">...</span></h2>
            <p>Koalas ekosistemine ho≈ü geldin. Arkada≈ülarƒ±nƒ± davet ederek kazanmaya ba≈üla.</p>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <span>Token Durumu:</span>
                <b style="color:var(--yellow);"><span id="main-kls">0.00</span> KLS</b>
            </div>
        </div>
    </div>

    <div id="p-friends" class="page">
        <h2>Davet Paneli</h2>
        <div class="card">
            <div class="balance-title">Davet Linkin (Kopyalamak i√ßin dokun)</div>
            <div class="ref-box" id="ref-link-text" onclick="copyRef()">Y√ºkleniyor...</div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>Arkada≈ülar (<span id="friend-count">0</span>)</h3>
        </div>
        
        <div id="friends-list">
            </div>
    </div>

    <div id="p-wallet" class="page">
        <h2>C√ºzdanƒ±m</h2>
        <div class="card wallet-header">
            <div class="balance-title">Toplam Bakiyen</div>
            <div class="balance-value">$<span id="main-usdt">0.0000</span></div>
        </div>
        
        <div class="card">
            <h3>ƒ∞≈ülemler</h3>
            <button class="withdraw-btn" onclick="tg.showAlert('Minimum √ßekim tutarƒ± $10.00')">PARA √áEK</button>
            <p style="font-size:12px; text-align:center; opacity:0.5; margin-top:15px;">√ñdemeler 24 saat i√ßinde c√ºzdanƒ±nƒ±za yansƒ±r.</p>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-btn active-nav" onclick="showTab('home')">
            <span>üè†</span>Ana Sayfa
        </button>
        <button class="nav-btn" onclick="showTab('friends')">
            <span>üë•</span>Arkada≈ülar
        </button>
        <button class="nav-btn" onclick="showTab('wallet')">
            <span>üí∞</span>C√ºzdan
        </button>
    </nav>
</div>

</body>
</html>
