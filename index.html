<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PI NEBULA - MINING PRO</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Montserrat:wght@900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #4c3ba5; --yellow: #fbc02d; --dark: #2c1a74; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Fredoka', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: white; overflow: hidden; height: 100vh;
            background-image: radial-gradient(circle at 50% 30%, #5e48c2 0%, #2c1a74 100%);
        }

        #app { width:100%; max-width:450px; height:100vh; margin:auto; position:relative; display:flex; flex-direction:column; }

        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .score-pill { background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 8px; }
        .coin { width: 20px; height: 20px; background: gold; border-radius: 50%; box-shadow: 0 0 10px gold; }

        .view { display: none; flex: 1; padding: 20px; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .view.active { display: flex; }

        /* MADENCƒ∞Lƒ∞K EKRANI √ñZEL */
        #v-mining { background: rgba(0,0,0,0.8); z-index: 100; }
        .mining-pulse { width: 150px; height: 150px; border-radius: 50%; border: 5px solid var(--yellow); animation: pulse 1.5s infinite; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }

        /* ANA EKRAN */
        .pet-name { background: var(--yellow); color: var(--dark); padding: 4px 12px; border-radius: 10px; font-weight: 700; margin-bottom: 10px; }
        .hero-img { width: 250px; filter: drop-shadow(0 15px 25px rgba(0,0,0,0.5)); margin-bottom: 15px; }
        .bal-val { font-family: 'Montserrat', sans-serif; font-size: 2.5rem; color: var(--yellow); margin-bottom: 20px; }

        /* BUTONLAR */
        .btn-big { 
            background: linear-gradient(180deg, #ffee58 0%, #fbc02d 100%); border: none; border-radius: 25px; 
            padding: 20px; color: var(--dark); font-size: 1.5rem; font-weight: 700; width: 80%;
            box-shadow: 0 8px 0 #9e7500; cursor: pointer; transition: 0.1s;
        }
        .btn-big:active { transform: translateY(4px); box-shadow: 0 4px 0 #9e7500; }
        .btn-stop { background: #ff1744; box-shadow: 0 8px 0 #b2102f; color: white; margin-top: 20px; }

        /* NAV */
        nav { height: 90px; background: rgba(106, 83, 207, 0.7); backdrop-filter: blur(10px); border-radius: 30px 30px 0 0; display: flex; justify-content: space-around; align-items: center; }
        .nav-item { opacity: 0.5; font-size: 0.7rem; color: white; text-align: center; }
        .nav-item.active { opacity: 1; color: var(--yellow); }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div class="score-pill">
            <div class="coin"></div>
            <div id="top-bal">0.00</div>
        </div>
        <div id="status-tag" style="font-size: 0.7rem; color: #00ff00;">‚óè ONLINE</div>
    </header>

    <div id="v-home" class="view active">
        <div class="pet-name">Nebula Guardian</div>
        <img src="yourfantastic.jpg" class="hero-img" onerror="this.src='https://via.placeholder.com/250?text=yourfantastic.jpg+Not+Found'">
        <h1 style="line-height: 0.9; margin-bottom: 10px;">YOUR<br>FANTASTIC PET</h1>
        <div class="bal-val" id="main-bal">0.00</div>
        <button class="btn-big" onclick="startMining()">PLAY / START</button>
    </div>

    <div id="v-mining" class="view">
        <div class="mining-pulse">‚õèÔ∏è</div>
        <h2 style="color:var(--yellow)">MINING IN PROGRESS</h2>
        <div class="bal-val" id="session-bal" style="font-size: 3.5rem;">0.0000</div>
        <p style="opacity: 0.7;">Kazƒ±lan puanlar durdurunca hesaba ge√ßer.</p>
        <button class="btn-big btn-stop" onclick="stopMining()">STOP MINING</button>
    </div>

    <div id="v-admin" class="view">
        <h2>ADMIN CONTROL</h2>
        <button class="btn-big" style="font-size: 1rem; margin-top: 10px;" onclick="add500()">ADD 500 PI</button>
        <div id="user-list" style="width:100%; margin-top: 20px;"></div>
    </div>

    <nav id="main-nav">
        <div class="nav-item" onclick="tab('v-home')">üêæ<br>Home</div>
        <div class="nav-item" onclick="tab('v-wallet')">üí≥<br>Wallet</div>
        <div id="adm-nav" class="nav-item" style="display:none;" onclick="tab('v-admin')">‚öôÔ∏è<br>Admin</div>
    </nav>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyApwj-8tB4qxqe8yJ9uP7XuKfEdT2lwYv4",
        authDomain: "fonix-b4de6.firebaseapp.com",
        projectId: "fonix-b4de6",
        storageBucket: "fonix-b4de6.firebasestorage.app",
        messagingSenderId: "20899545652",
        appId: "1:20899545652:web:f32ef599f0c8d3deaec061"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tg = window.Telegram.WebApp;
    const MY_ID = "8392479231";

    let uid = tg.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "dev_user";
    let uData = { pi: 0, username: tg.initDataUnsafe?.user?.username || "Guest" };
    let miningInt = null;
    let sessionPi = 0;

    function init() {
        tg.expand();
        db.collection("users").doc(uid).onSnapshot(doc => {
            if(doc.exists) { uData = doc.data(); updateUI(); }
            else { db.collection("users").doc(uid).set(uData); }
        });
        if(uid === MY_ID) document.getElementById('adm-nav').style.display = 'block';
    }

    function startMining() {
        tab('v-mining');
        document.getElementById('main-nav').style.pointerEvents = 'none'; // Kazƒ±m yaparken men√ºy√º kitle
        document.getElementById('main-nav').style.opacity = '0.3';
        
        sessionPi = 0;
        miningInt = setInterval(() => {
            sessionPi += 0.00052; // Kazƒ±m hƒ±zƒ±
            document.getElementById('session-bal').innerText = sessionPi.toFixed(4);
        }, 100);
    }

    function stopMining() {
        clearInterval(miningInt);
        // Bakiyeyi Firebas'e aktar
        db.collection("users").doc(uid).update({
            pi: firebase.firestore.FieldValue.increment(sessionPi)
        }).then(() => {
            tab('v-home');
            document.getElementById('main-nav').style.pointerEvents = 'auto';
            document.getElementById('main-nav').style.opacity = '1';
            tg.showAlert("Mining bitti! Bakiyenize " + sessionPi.toFixed(2) + " PI eklendi.");
        });
    }

    function updateUI() {
        document.getElementById('top-bal').innerText = uData.pi.toFixed(2);
        document.getElementById('main-bal').innerText = uData.pi.toFixed(2);
    }

    function tab(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'v-admin') loadAdmin();
    }

    async function add500() {
        await db.collection("users").doc(MY_ID).update({ pi: firebase.firestore.FieldValue.increment(500) });
    }

    async function loadAdmin() {
        const snap = await db.collection("users").orderBy("pi", "desc").limit(15).get();
        const list = document.getElementById('user-list'); list.innerHTML = "";
        snap.forEach(doc => {
            list.innerHTML += `<div style="padding:10px; background:rgba(0,0,0,0.2); margin-bottom:5px; border-radius:10px;">@${doc.data().username}: ${doc.data().pi.toFixed(2)}</div>`;
        });
    }

    window.onload = init;
</script>
</body>
</html>
