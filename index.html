<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PI NEBULA PRO</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Montserrat:wght@900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg-home: #4c3ba5; 
            --bg-mine: #0a0a0a; 
            --yellow: #fbc02d; 
            --neon: #8eff31; 
            --dark: #1a1a1a;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Fredoka', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-home); color: white; overflow: hidden; height: 100vh; }

        /* --- STAGE 1: ANA GİRİŞ --- */
        #stage-home { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; text-align: center; padding: 20px;
            background-image: radial-gradient(circle at 50% 30%, #5e48c2 0%, #2c1a74 100%);
        }
        .hero-img { width: 240px; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.5)); margin-bottom: 20px; }
        .bal-display { font-family: 'Montserrat'; font-size: 2.8rem; color: var(--yellow); margin-bottom: 25px; text-shadow: 0 0 15px rgba(251, 192, 45, 0.3); }

        /* --- STAGE 2: MADENCİLİK (PINIX FAN) --- */
        #stage-mining { 
            display: none; flex-direction: column; align-items: center; justify-content: space-around; 
            height: 100vh; background: var(--bg-mine); padding: 20px;
        }
        .fan-container { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; }
        .pinix-fan { 
            width: 100%; height: 100%; border-radius: 50%; border: 8px solid var(--neon); 
            box-shadow: 0 0 40px rgba(142, 255, 49, 0.2); object-fit: cover;
        }
        .spinning { animation: rotateFan 1.5s linear infinite; }
        @keyframes rotateFan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- STAGE 3: ADMIN --- */
        #stage-admin { display: none; height: 100vh; padding: 30px; background: #111; overflow-y: auto; }
        .adm-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-left: 4px solid var(--yellow); }

        /* --- BUTONLAR --- */
        .btn-action { 
            width: 85%; padding: 20px; border: none; border-radius: 50px; 
            font-size: 1.5rem; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn-play { background: var(--yellow); color: #2c1a74; box-shadow: 0 8px 0 #9e7500; }
        .btn-stop { background: #ff3131; color: white; box-shadow: 0 8px 0 #b2102f; }
        .btn-action:active { transform: translateY(4px); box-shadow: 0 4px 0 rgba(0,0,0,0.3); }

        /* --- STATS & UI --- */
        .stats-grid { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100%; 
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 25px; gap: 10px;
        }
        .stat-box { text-align: center; }
        .stat-val { color: var(--neon); font-size: 1.1rem; font-weight: 700; display: block; }
        .stat-lbl { font-size: 0.6rem; opacity: 0.5; text-transform: uppercase; }

        header { position: absolute; top: 20px; width: 100%; padding: 0 25px; display: flex; justify-content: space-between; z-index: 50; }
        .badge { background: rgba(0,0,0,0.3); padding: 6px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }

        #ghost-alert { display:none; background: #ff1744; text-align: center; padding: 5px; font-weight: 900; font-size: 0.7rem; width: 100%; }
    </style>
</head>
<body>

<div id="app">
    <div id="ghost-alert" onclick="exitGhost()">SPECTATING: <span id="g-name"></span> (EXIT)</div>

    <div id="stage-home">
        <header>
            <div class="badge" style="color:var(--yellow)">LEVEL <span id="h-lvl">1</span></div>
            <div class="badge" onclick="checkAdmin()">● ONLINE</div>
        </header>
        
        <img src="yourfantastic.jpg" class="hero-img" onerror="this.src='https://via.placeholder.com/240?text=yourfantastic.jpg'">
        <h1 style="line-height: 0.9; margin-bottom: 10px;">YOUR<br>FANTASTIC PET</h1>
        <div class="bal-display" id="total-bal">0.00</div>
        
        <button class="btn-action btn-play" onclick="startMiningProcess()">PLAY / START</button>
        <div style="margin-top:20px; opacity:0.3; font-size:0.7rem;">ID: 8392479231</div>
    </div>

    <div id="stage-mining">
        <div style="text-align:center;">
            <h2 style="color:var(--neon); letter-spacing:3px;">SYSTEM ACTIVE</h2>
            <div style="font-size:0.7rem; opacity:0.4;">POWERING NEBULA CORE</div>
        </div>

        <div class="fan-container">
            <img src="pinix.jpg" id="fan-img" class="pinix-fan spinning" onerror="this.src='https://via.placeholder.com/280?text=pinix.jpg'">
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <span class="stat-val" id="m-time">00:00</span>
                <span class="stat-lbl">DURATION</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="m-pi">0.0000</span>
                <span class="stat-lbl">EARNED PI</span>
            </div>
            <div class="stat-box">
                <span class="stat-val">0.0005/s</span>
                <span class="stat-lbl">SPEED</span>
            </div>
        </div>

        <button class="btn-action btn-stop" onclick="stopMiningProcess()">STOP & COLLECT</button>
    </div>

    <div id="stage-admin">
        <h2 style="color:var(--yellow); margin-bottom:20px;">ADMIN PANEL</h2>
        <button class="btn-action btn-play" style="font-size:1rem; margin-bottom:20px;" onclick="add500()">+500 PI TO MY ACCOUNT</button>
        <button class="btn-action btn-stop" style="font-size:1rem; margin-bottom:20px;" onclick="showHome()">BACK TO HOME</button>
        <div id="adm-list"></div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyApwj-8tB4qxqe8yJ9uP7XuKfEdT2lwYv4",
        authDomain: "fonix-b4de6.firebaseapp.com",
        projectId: "fonix-b4de6",
        storageBucket: "fonix-b4de6.firebasestorage.app",
        messagingSenderId: "20899545652",
        appId: "1:20899545652:web:f32ef599f0c8d3deaec061"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tg = window.Telegram.WebApp;
    const ADMIN_ID = "8392479231";

    let realUid = tg.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "dev_test";
    let activeUid = realUid;
    let uData = { pi: 0, lvl: 1, username: tg.initDataUnsafe?.user?.username || "Guest" };
    
    let miningInt = null;
    let seconds = 0;
    let sessionPi = 0;

    function init() {
        tg.expand();
        db.collection("users").doc(activeUid).onSnapshot(doc => {
            if(doc.exists) { 
                uData = doc.data(); 
                document.getElementById('total-bal').innerText = uData.pi.toFixed(2);
                document.getElementById('h-lvl').innerText = uData.lvl || 1;
                if(activeUid !== realUid) {
                    document.getElementById('ghost-alert').style.display = 'block';
                    document.getElementById('g-name').innerText = uData.username;
                } else {
                    document.getElementById('ghost-alert').style.display = 'none';
                }
            } else { 
                db.collection("users").doc(activeUid).set(uData); 
            }
        });
    }

    // --- MİNİNG KONTROLLERİ ---
    function startMiningProcess() {
        if(activeUid !== realUid) return;
        document.getElementById('stage-home').style.display = 'none';
        document.getElementById('stage-mining').style.display = 'flex';
        
        seconds = 0; sessionPi = 0;
        miningInt = setInterval(() => {
            seconds++;
            sessionPi += 0.0005;
            updateMiningUI();
        }, 1000);
        tg.HapticFeedback.impactOccurred('medium');
    }

    function stopMiningProcess() {
        clearInterval(miningInt);
        db.collection("users").doc(realUid).update({
            pi: firebase.firestore.FieldValue.increment(sessionPi)
        }).then(() => {
            document.getElementById('stage-mining').style.display = 'none';
            document.getElementById('stage-home').style.display = 'flex';
            tg.showAlert(`Kazanılan: ${sessionPi.toFixed(4)} PI hesaba eklendi!`);
        });
    }

    function updateMiningUI() {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        document.getElementById('m-time').innerText = `${m}:${s}`;
        document.getElementById('m-pi').innerText = sessionPi.toFixed(4);
    }

    // --- ADMIN FONKSİYONLARI ---
    function checkAdmin() {
        if(realUid === ADMIN_ID) {
            document.getElementById('stage-home').style.display = 'none';
            document.getElementById('stage-admin').style.display = 'block';
            loadUserList();
        }
    }

    function showHome() {
        document.getElementById('stage-admin').style.display = 'none';
        document.getElementById('stage-home').style.display = 'flex';
    }

    async function add500() {
        await db.collection("users").doc(ADMIN_ID).update({ pi: firebase.firestore.FieldValue.increment(500) });
        tg.showAlert("500 PI Eklendi Patron!");
    }

    async function loadUserList() {
        const snap = await db.collection("users").orderBy("pi", "desc").limit(20).get();
        const container = document.getElementById('adm-list');
        container.innerHTML = "";
        snap.forEach(doc => {
            container.innerHTML += `
                <div class="adm-card" onclick="ghostMode('${doc.id}')">
                    <b>@${doc.data().username || 'NoName'}</b><br>
                    <span>Balance: ${doc.data().pi.toFixed(2)} PI</span>
                </div>`;
        });
    }

    function ghostMode(id) {
        activeUid = id;
        document.getElementById('stage-admin').style.display = 'none';
        document.getElementById('stage-home').style.display = 'flex';
        init();
    }

    function exitGhost() {
        activeUid = realUid;
        init();
    }

    window.onload = init;
</script>
</body>
</html>
